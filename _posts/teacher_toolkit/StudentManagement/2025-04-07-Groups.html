---
layout: aesthetihawk
active_tab: groups
title: Groups Management
type: issues
permalink: /student/groups
comments: false
---

<div class="max-w-6xl mx-auto p-4">
  <h2 class="text-2xl font-semibold mb-4">Group Management</h2>

  <!-- Search bar -->
  <input type="text" id="searchInput" placeholder="Search by Group ID or Member Name/Email"
         class="w-full p-2 border border-gray-300 rounded mb-4">

  <!-- Table -->
  <div class="overflow-x-auto bg-black shadow rounded">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-800 text-white">
        <tr>
          <th class="p-3 text-left">Group ID</th>
          <th class="p-3 text-left">Name</th>
          <th class="p-3 text-left">Period</th>
          <th class="p-3 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="groupTableBody" class="divide-y divide-gray-200">
        <!-- Populated via JS -->
      </tbody>
    </table>
  </div>

  <!-- Create Group Button -->
  <div class="flex justify-center mt-6">
    <button id="openCreateModal" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
      Create Group
    </button>
  </div>
</div>

<!-- Create Group Modal -->
<div id="createGroupModal" class="fixed inset-0 hidden bg-black bg-opacity-75 flex items-center justify-center z-50">
  <div class="bg-gray-900 bg-opacity-50 rounded-lg shadow-lg w-full max-w-3xl overflow-y-auto max-h-[90vh] text-white">
    <div class="flex justify-between items-center p-4 border-b border-gray-700">
      <h3 class="text-xl font-semibold">Create New Group</h3>
      <button class="text-gray-400 hover:text-gray-200" onclick="toggleModal('createGroupModal')">&times;</button>
    </div>
    <div class="p-4 space-y-4">
      <div>
        <label for="groupNameInput" class="block text-sm font-medium">Group Name</label>
        <input type="text" id="groupNameInput" placeholder="Enter group name"
               class="w-full p-2 mt-1 bg-gray-800 border border-gray-700 rounded text-white">
      </div>
      <div>
        <label for="groupPeriodInput" class="block text-sm font-medium">Group Period</label>
        <input type="text" id="groupPeriodInput" placeholder="Enter group period"
               class="w-full p-2 mt-1 bg-gray-800 border border-gray-700 rounded text-white">
      </div>
      <div class="border rounded p-4 max-h-[400px] overflow-y-auto bg-gray-800">
        <input type="text" id="userSearch" placeholder="Search users..."
               class="w-full p-2 mb-3 bg-gray-700 border border-gray-600 rounded text-white">
        <div id="createUserList" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <!-- Users checkboxes loaded here -->
        </div>
      </div>
    </div>
    <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
      <button onclick="toggleModal('createGroupModal')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">Cancel</button>
      <button id="createGroupBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Create Group</button>
    </div>
  </div>
</div>

<!-- Edit Group Modal -->
<div id="editGroupModal" class="fixed inset-0 hidden bg-black bg-opacity-75 flex items-center justify-center z-50">
  <div class="bg-gray-900 bg-opacity-50 rounded-lg shadow-lg w-full max-w-3xl overflow-y-auto max-h-[90vh] text-white">
    <div class="flex justify-between items-center p-4 border-b border-gray-700">
      <h3 class="text-xl font-semibold">Edit Group</h3>
      <button class="text-gray-400 hover:text-gray-200" onclick="toggleModal('editGroupModal')">&times;</button>
    </div>
    <div class="p-4 space-y-4">
      <input type="hidden" id="editGroupId" />
      <div>
        <label for="editGroupNameInput" class="block text-sm font-medium">Group Name</label>
        <input type="text" id="editGroupNameInput" placeholder="Enter group name"
               class="w-full p-2 mt-1 bg-gray-800 border border-gray-700 rounded text-white">
      </div>
      <div>
        <label for="editGroupPeriodInput" class="block text-sm font-medium">Group Period</label>
        <input type="text" id="editGroupPeriodInput" placeholder="Enter group period"
               class="w-full p-2 mt-1 bg-gray-800 border border-gray-700 rounded text-white">
      </div>
      <div class="border rounded p-4 max-h-[400px] overflow-y-auto bg-gray-800">
        <input type="text" id="userSearchEdit" placeholder="Search users..."
               class="w-full p-2 mb-3 bg-gray-700 border border-gray-600 rounded text-white">
        <div id="editUserList" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <!-- Users with checkboxes loaded here -->
        </div>
      </div>
    </div>
    <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
      <button onclick="toggleModal('editGroupModal')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">Cancel</button>
      <button id="saveEditGroupBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save Changes</button>
    </div>
  </div>
</div>

<script type="module">
// Modal toggle utility
function toggleModal(id) {
  const modal = document.getElementById(id);
  if (modal.classList.contains("hidden")) {
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    // Fetch users only when opening create modal
    if (id === "createGroupModal") fetchUsers();
  } else {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }
}

// Environment setup
import {javaURI, fetchOptions} from '{{site.baseurl}}/assets/js/api/config.js';

const postOptions = {...fetchOptions, method: "POST"};
const putOptions = {...fetchOptions, method: "PUT"};

const javaURL = javaURI + "/api/groups";
const personURL = javaURI + "/api/people";

const tableBody = document.getElementById("groupTableBody");

// Fetch and display groups
function getTable() {
  tableBody.innerHTML = ""; // Clear existing
  fetch(javaURL, fetchOptions)
    .then(res => res.json())
    .then(groups => {
      groups.forEach(group => {
        const groupId = group.id;
        const name = group.name;
        const period = group.period;

        const row = document.createElement("tr");
        row.className = "group-row";
        row.dataset.groupid = groupId;
        row.dataset.members = group.members
          .map(m => (m.name + m.email).toLowerCase())
          .join(" ");

        row.innerHTML = `
          <td>${groupId}</td>
          <td>${name}</td>
          <td>${period}</td>
          <td class="space-x-2">
            <button class="bg-blue-500 text-white px-2 py-1 rounded toggle-members" data-target="members-${groupId}">
              View Members
            </button>
            <button class="bg-yellow-400 text-black px-2 py-1 rounded edit-group" 
              data-groupid="${groupId}" data-name="${name}" data-period="${period}">
              Edit
            </button>
          </td>
        `;

        const memberRow = document.createElement("tr");
        memberRow.id = `members-${groupId}`;
        memberRow.className = "hidden";
        memberRow.innerHTML = `
          <td colspan="4">
            <table class="w-full border mt-2">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-2 border">UID</th>
                  <th class="p-2 border">Name</th>
                  <th class="p-2 border">Email</th>
                </tr>
              </thead>
              <tbody>
                ${group.members.map(m => `
                  <tr>
                    <td class="p-2 border">${m.uid}</td>
                    <td class="p-2 border">${m.name}</td>
                    <td class="p-2 border">${m.email}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </td>
        `;

        tableBody.appendChild(row);
        tableBody.appendChild(memberRow);
      });
    });
}

// Toggle member details visibility
tableBody.addEventListener("click", e => {
  if (e.target.classList.contains("toggle-members")) {
    const targetId = e.target.dataset.target;
    const memberRow = document.getElementById(targetId);
    if (memberRow) {
      memberRow.classList.toggle("hidden");
    }
  }
  // Edit group button
  if (e.target.classList.contains("edit-group")) {
    const groupId = e.target.dataset.groupid;
    const name = e.target.dataset.name;
    const period = e.target.dataset.period;
    loadUsersForEdit(groupId, name, period);
  }
});

// Search filtering
document.getElementById("searchInput").addEventListener("input", function () {
  const val = this.value.toLowerCase();
  document.querySelectorAll(".group-row").forEach(row => {
    const idMatch = row.cells[0].textContent.toLowerCase().includes(val);
    const membersMatch = row.dataset.members.includes(val);
    row.style.display = (idMatch || membersMatch) ? "" : "none";
    const memberRow = document.getElementById(`members-${row.dataset.groupid}`);
    if (memberRow) memberRow.style.display = row.style.display;
  });
});

// Create group modal open button
document.getElementById("openCreateModal").addEventListener("click", () => toggleModal("createGroupModal"));

// Load users for create modal
let allUsers = [];
function fetchUsers() {
  fetch(personURL, fetchOptions)
    .then(res => res.json())
    .then(users => {
      allUsers = users;
      renderUserCheckboxes(users, "createUserList");
    });
}

// Filter users in create modal
document.getElementById("userSearch").addEventListener("input", function () {
  const filter = this.value.toLowerCase();
  const filtered = allUsers.filter(u => 
    u.name.toLowerCase().includes(filter) || u.email.toLowerCase().includes(filter));
  renderUserCheckboxes(filtered, "createUserList");
});

// Render users with checkboxes
function renderUserCheckboxes(users, containerId, selectedUserIds = new Set()) {
  const container = document.getElementById(containerId);
  container.innerHTML = users.map(user => {
    const checked = selectedUserIds.has(user.uid) ? "checked" : "";
    return `
      <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-700 p-1 rounded">
        <input type="checkbox" class="user-checkbox" value="${user.uid}" ${checked} />
        <span>${user.name} (${user.email})</span>
      </label>`;
  }).join("");
}

// Create Group submit handler
document.getElementById("createGroupBtn").addEventListener("click", () => {
  const name = document.getElementById("groupNameInput").value.trim();
  const period = document.getElementById("groupPeriodInput").value.trim();
  if (!name || !period) {
    alert("Please fill in both Group Name and Period.");
    return;
  }
  const selected = Array.from(document.querySelectorAll("#createUserList input.user-checkbox:checked"))
    .map(cb => cb.value);

  if (selected.length === 0) {
    alert("Please select at least one user.");
    return;
  }

  const body = {
    name: name,
    period: period,
    memberUIDs: selected
  };

  fetch(javaURL, {...postOptions, body: JSON.stringify(body)})
    .then(res => {
      if (!res.ok) throw new Error("Failed to create group.");
      return res.json();
    })
    .then(() => {
      toggleModal("createGroupModal");
      getTable();
      // Reset inputs
      document.getElementById("groupNameInput").value = "";
      document.getElementById("groupPeriodInput").value = "";
      document.getElementById("userSearch").value = "";
      renderUserCheckboxes(allUsers, "createUserList");
    })
    .catch(e => alert(e.message));
});

// Load users for edit modal and populate
function loadUsersForEdit(groupId, groupName, groupPeriod) {
  document.getElementById("editGroupId").value = groupId;
  document.getElementById("editGroupNameInput").value = groupName;
  document.getElementById("editGroupPeriodInput").value = groupPeriod;

  // Fetch group details to get members (to know who is currently in group)
  fetch(`${javaURL}/${groupId}`, fetchOptions)
    .then(res => res.json())
    .then(group => {
      fetch(personURL, fetchOptions)
        .then(res => res.json())
        .then(users => {
          const memberIds = new Set(group.members.map(m => m.uid));
          renderUserCheckboxes(users, "editUserList", memberIds);
          toggleModal("editGroupModal");
        });
    });
}

// Filter users in edit modal
document.getElementById("userSearchEdit").addEventListener("input", function () {
  const filter = this.value.toLowerCase();
  const container = document.getElementById("editUserList");
  Array.from(container.children).forEach(label => {
    const text = label.textContent.toLowerCase();
    label.style.display = text.includes(filter) ? "" : "none";
  });
});

// Save edited group
document.getElementById("saveEditGroupBtn").addEventListener("click", () => {
  const groupId = document.getElementById("editGroupId").value;
  const name = document.getElementById("editGroupNameInput").value.trim();
  const period = document.getElementById("editGroupPeriodInput").value.trim();

  if (!name || !period) {
    alert("Please fill in both Group Name and Period.");
    return;
  }

  const selected = Array.from(document.querySelectorAll("#editUserList input.user-checkbox:checked"))
    .map(cb => cb.value);

  if (selected.length === 0) {
    alert("Please select at least one user.");
    return;
  }

  const body = {
    name: name,
    period: period,
    memberUIDs: selected
  };

  fetch(`${javaURL}/${groupId}`, {...putOptions, body: JSON.stringify(body)})
    .then(res => {
      if (!res.ok) throw new Error("Failed to update group.");
      return res.json();
    })
    .then(() => {
      toggleModal("editGroupModal");
      getTable();
    })
    .catch(e => alert(e.message));
});

// Initial load
getTable();

</script>
