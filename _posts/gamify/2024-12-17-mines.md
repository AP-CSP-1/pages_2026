<script type="module">
  import { javaURI } from '../assets/js/api/config.js'; // Importing javaURI configuration

  const clickedCells = new Set(); // Store clicked cells
  let gameEnded = false; // Track if the game has ended

  // Retrieve JWT token from cookies
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  // Decode JWT token to extract email (or user data)
  function decodeJwt(token) {
    try {
      const payload = token.split('.')[1];
      const decodedPayload = atob(payload);
      return JSON.parse(decodedPayload);
    } catch (error) {
      console.error("Failed to decode JWT:", error);
      return null;
    }
  }

  // Fetch and display player's balance
  function fetchAndDisplayBalance() {
    const jwtToken = getCookie("jwt_java_spring"); // Retrieve the JWT token from the cookie

    if (!jwtToken) {
      console.error("JWT token not found in cookies.");
      return;
    }

    const userData = decodeJwt(jwtToken); // Decode the JWT to extract user data
    if (!userData || !userData.sub) {
      console.error("Email not found in JWT token.");
      return;
    }

    const email = userData.sub; // Extract email (or subject) from the decoded JWT payload

    fetch(`${javaURI}/api/casino/mines/balance/${email}`)
      .then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error("Failed to fetch balance");
        }
      })
      .then(balance => {
        const winningsDisplay = document.getElementById("winningsDisplay");
        if (winningsDisplay) {
          winningsDisplay.textContent = `Balance: ${balance.toFixed(2)}`;
        }
      })
      .catch(error => console.error("Error fetching balance:", error));
  }

  // Function to start the game by sending POST request with stakes level
  function startGame(stakes) {
    const jwtToken = getCookie("jwt_java_spring"); // Retrieve the JWT token from the cookie

    if (!jwtToken) {
      console.error("JWT token not found in cookies.");
      return;
    }

    const userData = decodeJwt(jwtToken); // Decode the JWT to extract user data
    if (!userData || !userData.sub) {
      console.error("Email not found in JWT token.");
      return;
    }

    const email = userData.sub;
    const betSize = Number(document.getElementById("betAmount").value);

    fetch(`${javaURI}/api/casino/mines/stakes/${stakes}`, {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ betSize, email }),
    })
      .then(response => {
        if (response.ok) {
          console.log("Game started with stakes:", stakes);

          // Hide the popup and overlay
          const popup = document.getElementById("popup");
          const overlay = document.getElementById("overlay");
          if (popup) popup.style.display = "none";
          if (overlay) overlay.style.display = "none";

          // Fetch and display updated balance after the game starts
          fetchAndDisplayBalance();
        } else {
          return response.text().then(text => { throw new Error(text); });
        }
      })
      .catch(error => console.error("Error starting game:", error));
  }

  // Event listener for Bet button
  document.getElementById("betButton").onclick = function () {
    const bet = document.getElementById("betAmount").value;
    const stakes = document.getElementById("stakes").value;

    const errorElement = document.getElementById("error");
    if (errorElement) errorElement.style.display = "none"; // Hide previous errors

    if (bet && !isNaN(bet) && Number(bet) >= 1000 && stakes) {
      startGame(stakes.toLowerCase()); // Start the game with selected stakes
    } else {
      let errorMessage = "Please enter a valid amount and select stakes.";
      if (!bet || isNaN(bet) || Number(bet) < 1000) {
        errorMessage = "Bet amount must be at least 1000.";
      } else if (!stakes) {
        errorMessage = "Please select stakes.";
      }
      if (errorElement) {
        errorElement.textContent = errorMessage;
        errorElement.style.display = "block";
      }
    }
  };

  // Event listeners for board cell clicks
  document.querySelectorAll("table td a").forEach(cell => {
    cell.onclick = function (event) {
      event.preventDefault();

      if (gameEnded) return; // Stop if the game is already over

      const cellCoords = this.textContent;
      if (clickedCells.has(cellCoords)) return; // Ignore if cell is already clicked

      clickedCells.add(cellCoords); // Mark cell as clicked

      // Remove the coordinates text
      this.textContent = ""; // Clear the text content of the clicked cell

      const [xCoord, yCoord] = cellCoords.split(',').map(Number);

      // Send GET request to check for a mine at (xCoord, yCoord)
      fetch(`${javaURI}/api/casino/mines/${xCoord - 1}/${yCoord - 1}`)
        .then(response => {
          if (response.ok) return response.json();
          else throw new Error("Failed to check mine");
        })
        .then(isMine => {
          if (isMine) {
            endGame("Boom! You hit a mine! Game Over.");
          } else {
            alert("Safe! No mine here.");
            updateWinnings(); // Update winnings if cell is safe
          }
        })
        .catch(error => console.error("Error checking mine:", error));
    };
  });

  // End game function
  function endGame(message) {
    gameEnded = true;
    alert(message);
    // Optionally reset the game state or reload the page
  }

  // Function to update winnings (stub)
  function updateWinnings() {
    // Logic to update winnings can be added here
    console.log("Winnings updated!");
  }
</script>
