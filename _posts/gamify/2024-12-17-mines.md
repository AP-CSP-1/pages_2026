---
layout: post
title: Mines
permalink: /gamify/mines
---

<style>
  .game-container {
    display: grid;
    grid-template-columns: repeat(5, 60px);
    gap: 10px;
    margin-bottom: 20px;
  }
  .tile {
    width: 60px;
    height: 60px;
    background-color: #2a2a2a;
    border: 1px solid #444;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
    cursor: pointer;
  }
  .tile.safe {
    background-color: #4caf50;
  }
  .tile.mine {
    background-color: #f44336;
  }
  .controls {
    margin-bottom: 20px;
  }
  button {
    padding: 10px 20px;
    background-color: #2196f3;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
  }
  button:hover {
    background-color: #1976d2;
  }
  .balance {
    font-size: 20px;
    margin-bottom: 20px;
  }
</style>

<h1>Mines Gambling Game</h1>
<div class="balance">Balance: $<span id="balance">Loading...</span></div>
<div class="controls">
  <input type="number" id="bet" placeholder="Enter your bet" min="1" />
  <button id="startButton">Start Game</button>
</div>
<div class="game-container" id="game-container"></div>

<script type="module">
  import { javaURI, fetchOptions } from '{{site.baseurl}}/assets/js/api/config.js';
  
  const gridSize = 5;
  const mineCount = 5;
  let currentMultiplier = 1;
  let gameActive = false;
  let currentBet = 0;
  let uid = "";

  const gameContainer = document.getElementById('game-container');
  const balanceDisplay = document.getElementById('balance');
  const betInput = document.getElementById('bet');

  async function getUID() {
    try {
      const response = await fetch(`${javaURI}/api/person/get`, fetchOptions);
      if (!response.ok) throw new Error('Failed to fetch UID');
      const data = await response.json();
      uid = data.uid;
      return uid;
    } catch (error) {
      console.error('Error fetching UID:', error);
      alert('Failed to authenticate. Please refresh the page.');
    }
  }

  async function updateBalance() {
    try {
      const response = await fetch(`${javaURI}/api/person/get`, fetchOptions);
      const data = await response.json();
      balanceDisplay.textContent = data.balance;
      return data.balance;
    } catch (error) {
      console.error('Error fetching balance:', error);
    }
  }

  async function adjustBalance(amount) {
    try {
      const response = await fetch(`${javaURI}/api/casino/update-balance`, {
        ...fetchOptions,
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ uid, amount }),
      });

      if (!response.ok) throw new Error('Balance update failed');
      return await response.json();
    } catch (error) {
      console.error('Error adjusting balance:', error);
      alert('Transaction failed. Please try again.');
      return null;
    }
  }

  function generateMines() {
    const mines = new Set();
    while (mines.size < mineCount) {
      mines.add(Math.floor(Math.random() * gridSize * gridSize));
    }
    return mines;
  }

  async function startGame() {
    if (gameActive) return alert('Game is already active!');
    
    currentBet = parseInt(betInput.value);
    if (isNaN(currentBet) || currentBet <= 0) {
      return alert('Please enter a valid bet amount!');
    }

    // Deduct bet from backend
    const deductionResult = await adjustBalance(-currentBet);
    if (!deductionResult) return;
    await updateBalance();

    gameActive = true;
    currentMultiplier = 1;
    gameContainer.innerHTML = '';

    const mines = generateMines();

    for (let i = 0; i < gridSize * gridSize; i++) {
      const tile = document.createElement('div');
      tile.classList.add('tile');
      tile.dataset.index = i;

      tile.addEventListener('click', async () => {
        if (!gameActive) return;

        if (mines.has(i)) {
          tile.classList.add('mine');
          gameActive = false;
          alert('Game Over! You hit a mine.');
        } else {
          tile.classList.add('safe');
          const winnings = Math.floor(currentBet * currentMultiplier);
          currentMultiplier += 0.5;

          // Add winnings to backend
          const winResult = await adjustBalance(winnings);
          if (winResult) {
            await updateBalance();
          }
        }
      });

      gameContainer.appendChild(tile);
    }
  }

  // Initial setup
  document.addEventListener('DOMContentLoaded', async () => {
    await getUID();
    await updateBalance();
    document.getElementById('startButton').addEventListener('click', startGame);
  });
</script>