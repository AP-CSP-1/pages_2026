<head>
    <link rel="stylesheet" href="login.css">
</head>

<div class="container">
    <div class="components">
        <form id="login-form" class="form">
            <input id="username" class="form__input" type="text" placeholder="Full Name" /><br><br>
            <input id="email" class="form__input" type="text" placeholder="Email" /><br><br>
            <input id="myplan" class="form__input" type="text" placeholder="MyPlan Username" /><br><br>
            <input id="password" class="form__input" type="password" placeholder="Password" /><br><br>

            <!-- create account Button -->
            <button id="login-btn" class="btn btn__primary" type="button">
                <p>Create Account</p>
            </button><br>

            <!-- go back to login page Button -->
            <a href="{{site.baseurl}}/login" class="btn btn__secondary" id="create-account-btn">
                <p>Back to Login</p>
            </a>
        </form>

        <!-- Error Chip (Hidden Initially) -->
        <div class="chip" id="error-chip" style="display:none;">
            <div class="chip__icon">
                <ion-icon name="warning-outline"></ion-icon>
            </div>
            <p>Unable to create account.</p> <!-- This message can change dynamically -->
            <span class="chip__close" onclick="hideChip()"><ion-icon name="close"></ion-icon></span>
        </div>
    </div>
</div>

<script>
    document.querySelectorAll('.form__input').forEach(input => {
        input.addEventListener('input', function () {
            if (input.value) {
                input.classList.add('has-content');
            } else {
                input.classList.remove('has-content');
            }
        });
    });

    document.getElementById('login-btn').addEventListener('click', function () {
        // get all the important info
        var username = document.getElementById('username').value; // this is your full name
        var email = document.getElementById('email').value; // this is your email
        var myplan = document.getElementById('myplan').value; // this is your myplan ID
        var password = document.getElementById('password').value; // this is your password

        // make a form
        const formData = new FormData();
        formData.append("email", email);
        formData.append("password", password);
        formData.append("name", username);
        formData.append("dob", "0001-01-01");
        formData.append("myplan", myplan);

        // Send the request
        fetch("http://localhost:8085/mvc/person/create", {
            method: "POST", // Set HTTP method to POST
            body: formData // Directly pass the FormData object
        })
            .then(async response => {
                if (!response.ok) {
                    // Check if the error is a 401 Unauthorized with specific error message
                    const errorData = await response.json();
                    if (response.status === 401) {
                        // Do not display error chip for this specific 401 error
                        console.log("Unauthorized: Not displaying error chip");
                        return;
                    }

                    // Show error message for other errors
                    document.getElementById('error-chip').style.display = 'flex';
                    throw new Error("Network response was not ok");
                }
                else {
                    // Success: handle login (redirect, etc.)
                    window.location.href = '{{site.baseurl}}/login'; // example redirect
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Show error message for network failure or other issues
                document.getElementById('error-chip').style.display = 'flex';
            });

    });

    // Function to hide the error chip when the close button is clicked
    function hideChip() {
        document.getElementById('error-chip').style.display = 'none';
    }
</script>

<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>