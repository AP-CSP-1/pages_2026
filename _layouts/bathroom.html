<head>
    <link rel="stylesheet" href="bathroom.css">
</head>

<div class="container">
    <div class="components">
        <!-- queue header and your info like eta -->
        <div class="div1">
            <div class="queue-header">
                <h2 id="teacherName">Mr. Mortensen's Queue</h2>
            </div>

            <div class="queue-info">
                <p id="position">Your position in line: #</p>
                <p id="estimatedTime">Estimated time: ~ mins</p>
            </div>

            <hr>
        </div>

        <!-- students in line -->
        <div class="div2">
            <div class="queue-list">
                <p>Students currently in line:</p>
                <ul id="studentList">
                    <!-- Students will be listed here -->
                </ul>

                <div class="queue-buttons queue-actions">
                    <button type="button" onclick="addToQueue()">Add Me to Queue</button>
                    <button type="button" onclick="removeFromQueue()">Remove Me from Queue</button>
                    <button type="button" onclick="goToProfile()">Go to Profile</button>
                    <button type="button" onclick="reportIssue()">Report Issue</button>
                    <button type="button" onclick="viewIssues()">View Issues</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

<script>
    function goToProfile() {
        // Redirect to profile page
        window.location.href = "{{site.baseurl}}/profile";
    }

    function reportIssue() {
        // Redirect to issue report page
        window.location.href = "{{site.baseurl}}/issue";
    }

    function viewIssues() {
        window.location.href = "{{site.baseurl}}/get-issues"
    }
    // Global variable to store queue data
    window.studentsInQueue = [];

    function displayQueue() {
        const studentList = document.getElementById("studentList");
        studentList.innerHTML = ""; // Clear the list

        // Display the queue
        window.studentsInQueue.forEach((student) => {
            const listItem = document.createElement("li");
            listItem.textContent = student;
            if (student === studentName) listItem.style.color = "red"; // Highlight user's name in red
            studentList.appendChild(listItem);
        });

        // Disable "Add Me to Queue" button if student is already in queue
        const addButton = document.querySelector('button[onclick="addToQueue()"]');
        if (window.studentsInQueue.includes(studentName)) {
            addButton.disabled = true;
        } else {
            addButton.disabled = false;
        }

        // Update position and estimated time
        const position = window.studentsInQueue.indexOf(studentName) + 1;
        document.getElementById("position").textContent = `Your position in line: #${position}`;
        document.getElementById("estimatedTime").textContent = `Estimated time: ~${position * 3} mins`;
    }

    // Initial display
    displayQueue();
</script>

<script>
    const url = `http://localhost:8085/api/queue`;
    const getUrl = url + '/all';
    const addUrl = url + '/add';
    const removeUrl = url + '/remove';
    const approveUrl = url + '/approve';

    const fetchOptions = {
        headers: {
            "Content-Type": "application/json"
        }
    };

    const postOptions = {
        ...fetchOptions,
        method: 'POST',
    };
    const deleteOptions = {
        ...fetchOptions,
        method: 'DELETE',
    };

    // Get teacher name and student name from local storage or variables
    const teacherName = "Mortensen"; // Replace with dynamic teacher name if needed
    const studentName = localStorage.getItem("email"); // Assume stored from login

    function fetchQueueData() {
        fetch(getUrl, fetchOptions)
            .then(response => {
                if (response.status !== 200) {
                    console.error("Failed to fetch queue data.");
                    return;
                }
                return response.json();
            })
            .then(data => {
                console.log("Queue data:", data);
                const mortensenQueue = data.find(queue => queue.teacherName === teacherName);
                if (mortensenQueue) {
                    window.studentsInQueue = mortensenQueue.peopleQueue.split(','); // Convert the queue string into an array
                    displayQueue();

                    // Run approveStudent if there is at least one student in queue and the first student is the current user
                    if (window.studentsInQueue.length > 0 && window.studentsInQueue[0] === studentName) {
                        approveStudent();
                    }
                } else {
                    console.error("Mortensen's queue not found.");
                }
            })
            .catch(error => console.error("Error fetching data:", error));
    }


    // Function to add student to the queue
    function addToQueue() {
        const queuer = {
            teacherName: teacherName,
            studentName: studentName,
        };

        fetch(addUrl, {
            ...postOptions,
            body: JSON.stringify(queuer),
        })
            .then(response => {
                if (response.ok) {
                    fetchQueueData(); // Refresh the queue after adding
                } else {
                    alert("Failed to add to queue.");
                }
            })
            .catch(error => console.error("Error adding to queue:", error));
        console.log("Added to queue:", queuer);
    }

    // Function to remove student from the queue
    function removeFromQueue() {
        const queuer = {
            teacherName: teacherName,
            studentName: studentName,
        };

        fetch(removeUrl, {
            ...deleteOptions,
            body: JSON.stringify(queuer),
        })
            .then(response => {
                if (response.ok) {
                    fetchQueueData(); // Refresh the queue after removing
                } else {
                    alert("Failed to remove from queue.");
                }
            })
            .catch(error => console.error("Error removing from queue:", error));
        console.log("Removed from queue:", queuer);
    }

    // Function to approve student who is first in line
    function approveStudent() {
        const queuer = {
            teacherName: teacherName,
            studentName: window.studentsInQueue[0],
        };

        fetch(approveUrl, {
            ...postOptions,
            body: JSON.stringify(queuer),
        })
            .then(response => {
                if (response.ok) {
                    window.location.href = "{{site.baseurl}}/hallpass";
                }
                else {
                    alert("Failed to approve student.");
                }
            })
            .catch(error => console.error("Error approving student:", error));
    }

    // Fetch data every 10 seconds
    setInterval(fetchQueueData, 10000);

    // Initial fetch
    fetchQueueData();
</script>