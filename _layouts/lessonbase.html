---
layout: opencs
---

{% if page.wide %}
<style>
  .wrapper {
    max-width: 100% !important;
    padding: 0 1rem;
  }
</style>
{% endif %}

<div class="lesson-container">
  <!-- Sidebar -->
  {% if page.sidebar != false %}
  <aside class="lesson-sidebar">
    {% if page.sidebar_title %}
      <h3>{{ page.sidebar_title }}</h3>
    {% endif %}

    <!-- Lesson Links -->
    {% if page.lesson_links %}
    <h4>Lessons</h4>
    <ul>
      {% for link in page.lesson_links %}
        <li><a href="{{ site.baseurl }}{{ link.url }}">{{ link.text }}</a></li>
      {% endfor %}
    </ul>
    {% endif %}

    <!-- Time Tracker -->
    {% if page.enable_timer %}
    <h4>‚è±Ô∏è Study Time</h4>
    <div class="time-display"><span id="total-time">0:00</span></div>
    <div id="timer-status" class="timer-status">Active</div>
    {% endif %}

    <!-- Progress -->
    {% if page.enable_progress %}
    <h4>üìä Your Progress</h4>
    <div class="progress-bar"><div class="progress-fill" id="lesson-progress"></div></div>
    <p id="progress-text">0% complete</p>
    <button id="reset-progress" class="btn small-btn">Reset Progress</button>
    {% endif %}

    <!-- Badges -->
    {% if page.enable_badges %}
    <h4>üèÖ Your Badges</h4>
    <p id="badges">No badges yet...</p>
    {% endif %}
  </aside>
  {% endif %}

  <!-- Main Content -->
  <main class="lesson-content">
    <h1>{{ page.title }}</h1>
    <div class="post-content">
      {{ content }}
    </div>

    <!-- Progress Configuration (hidden data for JavaScript) -->
    {% if page.enable_progress %}
    <script id="progress-config" type="application/json">
    {
      "totalLessons": {{ page.progress_total | default: 6 | jsonify }}
    }
    </script>
    {% endif %}

    <!-- Badge Configuration (hidden data for JavaScript) -->
    {% if page.enable_badges %}
    <script id="badge-config" type="application/json">
    {
      "lessonBadges": {{ page.lesson_badges | default: '[]' | jsonify }},
      "lessonKey": {{ page.lesson_key | default: '' | jsonify }}
    }
    </script>
    {% endif %}

    <!-- Flashcards Section -->
    {% if page.enable_flashcards %}
    {% assign flashcard_file = page.flashcards | default: "flashcards" %}
    {% assign cards = site.data[flashcard_file].cards %}
    
    <hr>
    <div class="flashcards-section">
      <h3>üóÇÔ∏è Flashcards</h3>
      
      {% if cards %}
      <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-bottom: 1rem; overflow: hidden;">
        <div style="height: 100%; background: linear-gradient(135deg, #6C63FF 0%, #536DFE 100%); transition: width 0.3s ease; width: 0%;" id="flashcard-progress"></div>
      </div>
      
      <div class="flashcard-deck">
        {% for card in cards %}
          {% assign index = forloop.index %}
          {% assign total = forloop.length %}
          
          {% if card.term and card.definition %}
            {% assign front = card.term %}
            {% assign back = card.definition %}
          {% else %}
            {% assign front = card | split: "|" | first %}
            {% assign back = card | split: "|" | last %}
          {% endif %}
          
          <div class="flashcard-container {% if index > 1 %}hidden{% endif %}" id="card-{{ index }}" data-index="{{ index }}" data-total="{{ total }}">
            <div class="flashcard-inner">
              <div class="flashcard-front">
                <div class="card-counter">{{ index }}/{{ total }}</div>
                <h3>{{ front }}</h3>
                <button class="btn" onclick="flipCard('card-{{ index }}')">Flip Card</button>
              </div>
              <div class="flashcard-back">
                <div class="card-counter">{{ index }}/{{ total }}</div>
                <h4>Answer:</h4>
                <p>{{ back }}</p>
                <button class="btn" onclick="flipCard('card-{{ index }}')">Flip Back</button>
              </div>
            </div>
            <div class="card-status" id="status-{{ index }}"></div>
          </div>
        {% endfor %}
      </div>
      
      <div class="flashcard-controls">
        <button class="btn" id="prev-btn" onclick="navigateCards('prev')" disabled>‚¨Ö Previous</button>
        
        <div class="flashcard-actions">
          <button class="btn know-btn" onclick="markCard('know')">‚úì</button>
          <button class="btn review-btn" onclick="markCard('review')">‚Üª</button>
        </div>
        
        <button class="btn" id="next-btn" onclick="navigateCards('next')">Next ‚û°</button>
      </div>
      
      {% else %}
      <div class="no-flashcards">
        <h4>No flashcards found.</h4>
        <p>Please check your flashcards.yml file.</p>
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% if page.enable_sandbox %}
    <hr>
    <div class="sandbox">
      <h3>üñ•Ô∏è Try It Yourself</h3>
      <textarea id="sandbox-code">{{ page.sandbox_code | default: "// Type your code here" }}</textarea>
      <button id="run-sandbox">Run Code</button>
      <pre id="sandbox-output"></pre>
    </div>
    {% endif %}

    {% if page.enable_blackboard %}
    <hr>
    <div class="blackboard">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.js" integrity="sha512-hOJ0mwaJavqi11j0XoBN1PtOJ3ykPdP6lp9n29WVVVVZxgx9LO7kMwyyhaznGJ+kbZrDN1jFZMt2G9bxkOHWFQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      <canvas id="blackboard-canvas"></canvas>
      <p class="blackboard-description">Press 'w' for white, press `r` for red, press `b` for blue, and press `g` for green. Press `c` to clear blackboard. </p>
    </div>
    {% endif %}
  
    {% if page.enable_demo %}
    <!-- Note: utilizes script tags in the HTML file as cannot dynamically use information from frontmatter in lessonbase.js -->
    <hr>
    <div class="demo">
      <label class="demo-label">
        <input type="checkbox" id="demo-toggle"> Show code
      </label>
      <div id="demo-canvas-wrapper">
        <canvas id="demo-canvas"></canvas>
        <!-- Make sure you put the normal JS code in the "demo_runtime_code" field in the frontmatter. -->
        <script>
          // Will need const canvas = document.getElementById("demo-canvas"); to interact with the canvas
          {{ page.demo_runtime_code }}
        </script>
      </div>
      <!-- Instead of writing '<' or '>' for brackets, use '&lt;' and '&gt;' else the HTML will actually be run instead of displayed. -->
      <pre id="demo-code" style="display:none; max-width:820px; margin:8px auto; overflow:auto;">
        <code>
          <!-- Need to use multiline YAML content in the frontmatter for the javascript -->
          {{ page.demo_display_code }}
        </code>
      </pre>
    </div>
    {% endif %}

    {% if page.enable_quiz %}
    <hr>
    <div class="lesson-quiz">
      <h3>üìù Quick Check</h3>
      <p>{{ page.quiz_prompt | default: "What did you learn?" }}</p>
      <textarea id="reflection-box"></textarea>
      <button id="save-reflection">Save</button>
      <p id="reflection-status"></p>
    </div>
    {% endif %}
    
    {% if page.enable_ai_grading %}
      <!-- Keep your hard-coded API key meta exactly as you want -->
      <meta name="gemini-api-key" content="AIzaSyDM-_Gj6GQTXHcym9cP_syUeopcF25x47o">

      <!-- Minimal config for the script -->
      <script id="lesson-config" type="application/json">
      {
        "title": {{ page.title | jsonify }},
        "model": {{ page.gemini_model | default: "gemini-1.5-flash" | jsonify }}
      }
      </script>

      <!-- AI grader (client-only) -->
      <script type="module" src="{{ '/assets/js/solitaire/ai-grader.js' | relative_url }}"></script>
    {% endif %}

    {% if page.resources %}
    <hr>
    <div class="resources">
      <h3>üìö Resources</h3>
      <ul>
        {% for r in page.resources %}
          <li><a href="{{ r.url }}" target="_blank">{{ r.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    {% if page.prev_url or page.next_url %}
    <div class="lesson-nav">
      {% if page.prev_url %}<a href="{{ page.prev_url }}" class="btn">‚¨Ö Previous</a>{% endif %}
      {% if page.next_url %}<a href="{{ page.next_url }}" class="btn">Next ‚û°</a>{% endif %}
    </div>
    {% endif %}
  </main>
  <!-- Plant Widget (will be styled by JavaScript) -->
  <div id="plant-widget-container"></div>
<script type="module">
import { javaURI, pythonURI, fetchOptions } from '/assets/js/api/config.js';

console.log('Plant script loaded');
console.log('javaURI:', javaURI);
console.log('pythonURI:', pythonURI);

// Plant API configuration
const plantURL = `${javaURI}/api/plant`;
const getStageURL = plantURL + "/stage/";
const advanceURL = plantURL + "/user/";

console.log('Plant API URLs configured:');
console.log('- Get stage URL:', getStageURL);
console.log('- Advance URL:', advanceURL);

// Prepare fetch options for POST requests
const postOptions = {...fetchOptions, method: 'POST'};

// Get user credentials
function getCredentials() {
  console.log('Getting user credentials...');
  const URL = pythonURI + '/api/id';
  return fetch(URL, {
      ...fetchOptions,
      credentials: 'include'
  })
  .then(response => {
      console.log('Credentials response status:', response.status);
      if (!response.ok) {
          console.warn("HTTP status code: " + response.status);
          return null;
      }
      return response.json();
  })
  .then(data => {
      console.log('Credentials data received:', data);
      return data;
  })
  .catch(err => {
      console.error("Fetch error: ", err);
      return null;
  });
}

// Create plant widget
function createPlantWidget() {
  console.log('Creating plant widget...');
  const container = document.getElementById('plant-widget-container');
  if (!container) {
    console.error('Plant container not found!');
    return;
  }
  
  container.innerHTML = `
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; 
                background: rgba(255, 255, 255, 0.95); border: 2px solid #4CAF50; 
                border-radius: 12px; padding: 12px; text-align: center; 
                box-shadow: 0 4px 16px rgba(0,0,0,0.15); width: 90px;">
      <img id="plant-img" src="/images/snake/tree/1.png" alt="Plant" 
           style="width: 60px; height: 60px; display: block;">
      <div id="plant-stage" style="font-size: 12px; color: #666; margin-top: 8px; font-weight: 500;">
        Stage 1
      </div>
      <div id="plant-lessons" style="font-size: 10px; color: #999; margin-top: 2px;">
        0 lessons
      </div>
    </div>
  `;
  console.log('Plant widget HTML added to container');
}

// Update plant display
function updatePlantDisplay(stage, totalLessons, fullyGrown) {
  console.log(`Updating plant display: Stage ${stage}, Lessons: ${totalLessons}, Fully grown: ${fullyGrown}`);
  
  const plantImg = document.getElementById('plant-img');
  const stageText = document.getElementById('plant-stage');
  const lessonsText = document.getElementById('plant-lessons');
  
  if (plantImg) {
    // Ensure stage is within valid range (1-6)
    const validStage = Math.min(Math.max(stage, 1), 6);
    const newSrc = `/images/snake/tree/${validStage}.png`;
    console.log('Updating plant image to:', newSrc);
    
    // Add error handling for image loading
    plantImg.onerror = function() {
      console.error('Failed to load plant image:', newSrc);
      console.log('Attempting fallback to stage 1');
      this.src = '/images/snake/tree/1.png';
    };
    
    plantImg.src = newSrc;
  } else {
    console.error('Plant image element not found!');
  }
  
  if (stageText) {
    if (fullyGrown) {
      stageText.textContent = 'Fully Grown!';
      stageText.style.color = '#4CAF50';
      console.log('Plant marked as fully grown');
    } else {
      stageText.textContent = `Stage ${stage}`;
      console.log('Plant stage text updated to:', `Stage ${stage}`);
    }
  } else {
    console.error('Plant stage text element not found!');
  }
  
  if (lessonsText) {
    lessonsText.textContent = `${totalLessons} lessons`;
    console.log('Lessons text updated to:', `${totalLessons} lessons`);
  } else {
    console.error('Plant lessons text element not found!');
  }
}

// Get current plant stage
function getCurrentPlantStage(uid) {
  console.log('Getting current plant stage for uid:', uid);
  const fullURL = getStageURL + uid;
  console.log('Making GET request to:', fullURL);
  
  fetch(fullURL, fetchOptions)
    .then(response => {
      console.log('Get plant stage response status:', response.status);
      if (response.status !== 200) {
        console.warn("GET plant stage API response failure: " + response.status);
        return;
      }
      return response.json();
    })
    .then(data => {
      if (data) {
        console.log('Plant stage data received:', data);
        updatePlantDisplay(data.currentStage, data.totalLessons, data.fullyGrown);
      }
    })
    .catch(err => {
      console.error("Plant stage fetch error:", err);
    });
}

// Advance plant stage
function advancePlantStage(uid) {
  console.log('ADVANCING PLANT STAGE for uid:', uid);
  const fullURL = advanceURL + uid + "/next";
  console.log('Making POST request to:', fullURL);
  
  fetch(fullURL, postOptions)
    .then(response => {
      console.log('Advance plant response status:', response.status);
      if (response.status !== 200) {
        console.warn("POST plant advance API response failure: " + response.status);
        return;
      }
      return response.json();
    })
    .then(data => {
      if (data) {
        console.log('Plant advance data received:', data);
        updatePlantDisplay(data.currentStage, data.totalLessons, data.fullyGrown);
        
        const message = data.fullyGrown ? 'Your plant is fully grown!' : `Plant grew to stage ${data.currentStage}!`;
        console.log('Showing celebration message:', message);
        
        showCelebrationMessage(message);
      }
    })
    .catch(err => {
      console.error("Plant advance error:", err);
    });
}

// Show celebration message
function showCelebrationMessage(message) {
  const celebration = document.createElement('div');
  celebration.style.cssText = `
    position: fixed; bottom: 120px; right: 20px; z-index: 1001;
    background: #4CAF50; color: white; padding: 12px 16px;
    border-radius: 8px; font-size: 14px; font-weight: bold;
    opacity: 0; transition: opacity 0.3s ease; max-width: 200px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  `;
  celebration.textContent = message;
  document.body.appendChild(celebration);
  
  // Animate in
  setTimeout(() => celebration.style.opacity = '1', 50);
  
  // Remove after 3 seconds
  setTimeout(() => {
    celebration.style.opacity = '0';
    setTimeout(() => {
      if (celebration.parentNode) {
        celebration.remove();
      }
    }, 300);
  }, 3000);
}

// Initialize plant system
function initializePlant() {
  console.log('Initializing plant system...');
  
  getCredentials().then(userData => {
    if (!userData) {
      console.log('No user logged in, skipping plant initialization');
      return;
    }
    
    const uid = userData.uid || userData.id || userData.userId || userData.user_id;
    console.log('User ID found:', uid);
    
    if (!uid) {
      console.error('No valid user ID found in userData:', userData);
      return;
    }
    
    // Create widget and get initial stage
    createPlantWidget();
    getCurrentPlantStage(uid);
    
    // Set up Next button listener with better detection
    setupNextButtonListener(uid);
    
    // ALTERNATIVE: Event delegation approach (works for all current and future buttons)
    document.body.addEventListener('click', function(event) {
      const target = event.target;
      
      // Check if clicked element is a Next button
      if (target.tagName === 'A' && 
          target.textContent && 
          target.textContent.toLowerCase().includes('next') &&
          (target.classList.contains('btn') || target.href.includes('lesson'))) {
        
        console.log('EVENT DELEGATION: Next button clicked!', target);
        console.log('Button text:', target.textContent);
        console.log('Button href:', target.href);
        
        setTimeout(() => {
          console.log('EVENT DELEGATION: Executing plant advancement...');
          advancePlantStage(uid);
        }, 500);
      }
    });
  });
}

// Setup Next button listener with improved detection
function setupNextButtonListener(uid) {
  console.log('Setting up Next button listener...');
  
  // Keep track of processed buttons to avoid duplicate listeners
  const processedButtons = new WeakSet();
  
  // Function to find and attach to Next button
  function attachToNextButton() {
    // Try multiple selectors to find the Next button
    const selectors = [
      '.lesson-nav a[href]:last-child',
      'a.btn',
      '.btn',
      'a[href*="lesson"]',
      '[class*="next"]'
    ];
    
    let nextButton = null;
    
    // Try each selector
    for (const selector of selectors) {
      const buttons = document.querySelectorAll(selector);
      for (const button of buttons) {
        if (button.textContent && 
            button.textContent.toLowerCase().includes('next') &&
            !processedButtons.has(button)) {
          nextButton = button;
          break;
        }
      }
      if (nextButton) break;
    }
    
    console.log('Next button found:', nextButton);
    
    if (nextButton && !processedButtons.has(nextButton)) {
      console.log('Next button text:', nextButton.textContent);
      console.log('Next button href:', nextButton.href);
      
      // Mark this button as processed
      processedButtons.add(nextButton);
      
      // Add new listener using event delegation approach
      nextButton.addEventListener('click', function(event) {
        console.log('NEXT BUTTON CLICKED! Starting plant advancement...');
        console.log('Clicked button:', this);
        console.log('Going to:', this.href);
        
        // Small delay to ensure the lesson completion is registered
        setTimeout(() => {
          console.log('Executing plant advancement...');
          advancePlantStage(uid);
        }, 500);
      });
      
      console.log('Click event listener added to Next button');
      return true;
    } else if (nextButton && processedButtons.has(nextButton)) {
      console.log('Next button already processed, skipping');
      return true;
    } else {
      console.warn('No Next button found on this page');
      return false;
    }
  }
  
  // Function to re-scan for buttons (for page changes)
  function rescanButtons() {
    console.log('Rescanning for Next buttons...');
    attachToNextButton();
  }
  
  // Try to attach immediately
  if (!attachToNextButton()) {
    // If not found, try again after delays
    setTimeout(attachToNextButton, 500);
    setTimeout(attachToNextButton, 1000);
    setTimeout(attachToNextButton, 2000);
  }
  
  // Set up mutation observer to catch dynamically added buttons
  const observer = new MutationObserver((mutations) => {
    let shouldRescan = false;
    
    mutations.forEach((mutation) => {
      if (mutation.type === 'childList') {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === Node.ELEMENT_NODE) {
            // Check if the added node contains a next button
            if (node.matches && (
                node.matches('a[href*="lesson"]') || 
                node.matches('.btn') ||
                node.matches('a.btn')
            )) {
              if (node.textContent && node.textContent.toLowerCase().includes('next')) {
                console.log('Dynamically added Next button detected:', node);
                shouldRescan = true;
              }
            }
            
            // Also check child elements
            const nextButtons = node.querySelectorAll && node.querySelectorAll('a[href*="lesson"], .btn, a.btn');
            if (nextButtons) {
              for (const btn of nextButtons) {
                if (btn.textContent && btn.textContent.toLowerCase().includes('next')) {
                  console.log('Dynamically added Next button found in children:', btn);
                  shouldRescan = true;
                  break;
                }
              }
            }
          }
        });
      }
    });
    
    if (shouldRescan) {
      // Delay to allow DOM to settle
      setTimeout(rescanButtons, 100);
    }
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
  
  // Also listen for page navigation events (if using a router)
  window.addEventListener('popstate', rescanButtons);
  
  // Listen for hash changes
  window.addEventListener('hashchange', rescanButtons);
  
  // Periodic rescan as fallback (every 3 seconds)
  setInterval(() => {
    console.log('Periodic button rescan...');
    rescanButtons();
  }, 3000);
}

// Initialize when DOM is ready
console.log('Setting up DOM ready event listener...');
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing plant...');
    initializePlant();
  });
} else {
  // DOM is already loaded
  console.log('DOM already loaded, initializing plant immediately...');
  initializePlant();
}</script>
</div>

<!-- Load your shared scripts & styles -->
<script src="{{ '/assets/js/lessonbase.js' | relative_url }}"></script>