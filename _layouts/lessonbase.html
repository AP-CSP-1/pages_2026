---
layout: opencs
---

{% if page.wide %}
<style>
  .wrapper {
    max-width: 100% !important;
    padding: 0 1rem;
  }
</style>
{% endif %}

<div class="lesson-container">
  <!-- Sidebar -->
  {% if page.sidebar != false %}
  <aside class="lesson-sidebar">
    {% if page.sidebar_title %}
      <h3>{{ page.sidebar_title }}</h3>
    {% endif %}

    <!-- Lesson Links -->
    {% if page.lesson_links %}
    <h4>Lessons</h4>
    <ul>
      {% for link in page.lesson_links %}
        <li><a href="{{ site.baseurl }}{{ link.url }}">{{ link.text }}</a></li>
      {% endfor %}
    </ul>
    {% endif %}

    <!-- Time Tracker -->
    {% if page.enable_timer %}
    <h4>‚è±Ô∏è Study Time</h4>
    <div class="time-display"><span id="total-time">0:00</span></div>
    <div id="timer-status" class="timer-status">Active</div>
    {% endif %}

    <!-- Progress -->
    {% if page.enable_progress %}
    <h4>üìä Your Progress</h4>
    <div class="progress-bar"><div class="progress-fill" id="lesson-progress"></div></div>
    <p id="progress-text">0% complete</p>
    <button id="reset-progress" class="btn small-btn">Reset Progress</button>
    {% endif %}

    <!-- Badges -->
    {% if page.enable_badges %}
    <h4>üèÖ Your Badges</h4>
    <p id="badges">No badges yet...</p>
    {% endif %}
  </aside>
  {% endif %}

  <!-- Main Content -->
  <main class="lesson-content">
    <h1>{{ page.title }}</h1>
    <div class="post-content">
      {{ content }}
    </div>

    <!-- Progress Configuration (hidden data for JavaScript) -->
    {% if page.enable_progress %}
    <script id="progress-config" type="application/json">
    {
      "totalLessons": {{ page.progress_total | default: 6 | jsonify }}
    }
    </script>
    {% endif %}

    <!-- Badge Configuration (hidden data for JavaScript) -->
    {% if page.enable_badges %}
    <script id="badge-config" type="application/json">
    {
      "lessonBadges": {{ page.lesson_badges | default: '[]' | jsonify }},
      "lessonKey": {{ page.lesson_key | default: '' | jsonify }}
    }
    </script>
    {% endif %}

    <!-- Flashcards Section -->
    {% if page.enable_flashcards %}
    {% assign flashcard_file = page.flashcards | default: "flashcards" %}
    {% assign cards = site.data[flashcard_file].cards %}
    
    <hr>
    <div class="flashcards-section">
      <h3>üóÇÔ∏è Flashcards</h3>
      
      {% if cards %}
      <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-bottom: 1rem; overflow: hidden;">
        <div style="height: 100%; background: linear-gradient(135deg, #6C63FF 0%, #536DFE 100%); transition: width 0.3s ease; width: 0%;" id="flashcard-progress"></div>
      </div>
      
      <div class="flashcard-deck">
        {% for card in cards %}
          {% assign index = forloop.index %}
          {% assign total = forloop.length %}
          
          {% if card.term and card.definition %}
            {% assign front = card.term %}
            {% assign back = card.definition %}
          {% else %}
            {% assign front = card | split: "|" | first %}
            {% assign back = card | split: "|" | last %}
          {% endif %}
          
          <div class="flashcard-container {% if index > 1 %}hidden{% endif %}" id="card-{{ index }}" data-index="{{ index }}" data-total="{{ total }}">
            <div class="flashcard-inner">
              <div class="flashcard-front">
                <div class="card-counter">{{ index }}/{{ total }}</div>
                <h3>{{ front }}</h3>
                <button class="btn" onclick="flipCard('card-{{ index }}')">Flip Card</button>
              </div>
              <div class="flashcard-back">
                <div class="card-counter">{{ index }}/{{ total }}</div>
                <h4>Answer:</h4>
                <p>{{ back }}</p>
                <button class="btn" onclick="flipCard('card-{{ index }}')">Flip Back</button>
              </div>
            </div>
            <div class="card-status" id="status-{{ index }}"></div>
          </div>
        {% endfor %}
      </div>
      
      <div class="flashcard-controls">
        <button class="btn" id="prev-btn" onclick="navigateCards('prev')" disabled>‚¨Ö Previous</button>
        
        <div class="flashcard-actions">
          <button class="btn know-btn" onclick="markCard('know')">‚úì</button>
          <button class="btn review-btn" onclick="markCard('review')">‚Üª</button>
        </div>
        
        <button class="btn" id="next-btn" onclick="navigateCards('next')">Next ‚û°</button>
      </div>
      
      {% else %}
      <div class="no-flashcards">
        <h4>No flashcards found.</h4>
        <p>Please check your flashcards.yml file.</p>
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% if page.enable_sandbox %}
    <hr>
    <div class="sandbox">
      <h3>üñ•Ô∏è Try It Yourself</h3>
      <textarea id="sandbox-code">{{ page.sandbox_code | default: "// Type your code here" }}</textarea>
      <button id="run-sandbox">Run Code</button>
      <pre id="sandbox-output"></pre>
    </div>
    {% endif %}

    {% if page.enable_blackboard %}
    <hr>
    <div class="blackboard">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.js" integrity="sha512-hOJ0mwaJavqi11j0XoBN1PtOJ3ykPdP6lp9n29WVVVVZxgx9LO7kMwyyhaznGJ+kbZrDN1jFZMt2G9bxkOHWFQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      <canvas id="blackboard-canvas"></canvas>
      <p class="blackboard-description">Press 'w' for white, press `r` for red, press `b` for blue, and press `g` for green. Press `c` to clear blackboard. </p>
    </div>
    {% endif %}
  
    {% if page.enable_demo %}
    <!-- Note: utilizes script tags in the HTML file as cannot dynamically use information from frontmatter in lessonbase.js -->
    <hr>
    <div class="demo">
      <label class="demo-label">
        <input type="checkbox" id="demo-toggle"> Show code
      </label>
      <div id="demo-canvas-wrapper">
        <canvas id="demo-canvas"></canvas>
        <!-- Make sure you put the normal JS code in the "demo_runtime_code" field in the frontmatter. -->
        <script>
          // Will need const canvas = document.getElementById("demo-canvas"); to interact with the canvas
          {{ page.demo_runtime_code }}
        </script>
      </div>
      <!-- Instead of writing '<' or '>' for brackets, use '&lt;' and '&gt;' else the HTML will actually be run instead of displayed. -->
      <pre id="demo-code" style="display:none; max-width:820px; margin:8px auto; overflow:auto;">
        <code>
          <!-- Need to use multiline YAML content in the frontmatter for the javascript -->
          {{ page.demo_display_code }}
        </code>
      </pre>
    </div>
    {% endif %}

    {% if page.enable_quiz %}
    <hr>
    <div class="lesson-quiz">
      <h3>üìù Quick Check</h3>
      <p>{{ page.quiz_prompt | default: "What did you learn?" }}</p>
      <textarea id="reflection-box"></textarea>
      <button id="save-reflection">Save</button>
      <p id="reflection-status"></p>
    </div>
    {% endif %}
    
    {% if page.enable_ai_grading %}
      <!-- Keep your hard-coded API key meta exactly as you want -->
      <meta name="gemini-api-key" content="AIzaSyDM-_Gj6GQTXHcym9cP_syUeopcF25x47o">

      <!-- Minimal config for the script -->
      <script id="lesson-config" type="application/json">
      {
        "title": {{ page.title | jsonify }},
        "model": {{ page.gemini_model | default: "gemini-1.5-flash" | jsonify }}
      }
      </script>

      <!-- AI grader (client-only) -->
      <script type="module" src="{{ '/assets/js/solitaire/ai-grader.js' | relative_url }}"></script>
    {% endif %}

    {% if page.resources %}
    <hr>
    <div class="resources">
      <h3>üìö Resources</h3>
      <ul>
        {% for r in page.resources %}
          <li><a href="{{ r.url }}" target="_blank">{{ r.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    {% if page.prev_url or page.next_url %}
    <div class="lesson-nav">
      {% if page.prev_url %}<a href="{{ page.prev_url }}" class="btn">‚¨Ö Previous</a>{% endif %}
      {% if page.next_url %}<a href="{{ page.next_url }}" class="btn">Next ‚û°</a>{% endif %}
    </div>
    {% endif %}
  </main>
  <!-- Plant Widget (will be styled by JavaScript) -->
  <div id="plant-widget-container"></div>
<script type="module">
import { javaURI, pythonURI, fetchOptions } from '/assets/js/api/config.js';

console.log('Plant script loaded');

// Plant API configuration
const plantURL = `${javaURI}/api/plant`;
const getStageURL = plantURL + "/stage/";
const advanceURL = plantURL + "/user/";

// Prepare fetch options for POST requests
const postOptions = {...fetchOptions, method: 'POST'};

// Lesson tracking variables
let currentUserId = null;
let hasAdvancedThisPage = false;
let currentPage = window.location.pathname;

// Lesson order mapping
const lessonOrder = [
  '/agile/pair_trio',
  '/snake/lesson/frontend', 
  '/snake/lesson/fundamentals',
  '/snake/lesson/hacks',
  '/snake/lesson/future-references'
];

// Get user credentials
function getCredentials() {
  console.log('Getting user credentials...');
  const URL = pythonURI + '/api/id';
  return fetch(URL, {
      ...fetchOptions,
      credentials: 'include'
  })
  .then(response => {
      if (!response.ok) {
          console.warn("HTTP status code: " + response.status);
          return null;
      }
      return response.json();
  })
  .then(data => {
      console.log('Credentials data received');
      return data;
  })
  .catch(err => {
      console.error("Fetch error: ", err);
      return null;
  });
}

// Create plant widget
function createPlantWidget() {
  console.log('Creating plant widget...');
  const container = document.getElementById('plant-widget-container');
  if (!container) {
    console.error('Plant container not found!');
    return;
  }
  
  container.innerHTML = `
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; 
                background: rgba(255, 255, 255, 0.95); border: 2px solid #4CAF50; 
                border-radius: 12px; padding: 12px; text-align: center; 
                box-shadow: 0 4px 16px rgba(0,0,0,0.15); width: 90px;">
      <img id="plant-img" src="/images/snake/tree/1.png" alt="Plant" 
           style="width: 60px; height: 60px; display: block;">
      <div id="plant-stage" style="font-size: 12px; color: #666; margin-top: 8px; font-weight: 500;">
        Stage 1
      </div>
      <div id="plant-lessons" style="font-size: 10px; color: #999; margin-top: 2px;">
        0 lessons
      </div>
      <div id="plant-progress" style="font-size: 9px; color: #aaa; margin-top: 2px;">
        Scroll to bottom
      </div>
    </div>
  `;
  console.log('Plant widget created with scroll tracker');
}

// Update plant display
function updatePlantDisplay(stage, totalLessons, fullyGrown) {
  console.log(`Updating plant display: Stage ${stage}, Lessons: ${totalLessons}`);
  
  const plantImg = document.getElementById('plant-img');
  const stageText = document.getElementById('plant-stage');
  const lessonsText = document.getElementById('plant-lessons');
  
  if (plantImg) {
    const validStage = Math.min(Math.max(stage, 1), 6);
    const newSrc = `/images/snake/tree/${validStage}.png`;
    
    plantImg.onerror = function() {
      console.error('Failed to load plant image:', newSrc);
      this.src = '/images/snake/tree/1.png';
    };
    
    plantImg.src = newSrc;
  }
  
  if (stageText) {
    if (fullyGrown) {
      stageText.textContent = 'Fully Grown!';
      stageText.style.color = '#4CAF50';
    } else {
      stageText.textContent = `Stage ${stage}`;
    }
  }
  
  if (lessonsText) {
    lessonsText.textContent = `${totalLessons} lessons`;
  }
}

// Update scroll progress display
function updateScrollProgress(percentage) {
  const progressElement = document.getElementById('plant-progress');
  if (progressElement) {
    if (percentage >= 95) {
      progressElement.textContent = 'Lesson complete!';
      progressElement.style.color = '#4CAF50';
      progressElement.style.fontWeight = 'bold';
    } else if (percentage >= 80) {
      progressElement.textContent = `${Math.round(percentage)}% - Almost there!`;
      progressElement.style.color = '#ff9800';
    } else {
      progressElement.textContent = `${Math.round(percentage)}% scrolled`;
      progressElement.style.color = '#aaa';
    }
  }
}

// Get current plant stage
function getCurrentPlantStage(uid) {
  console.log('Getting current plant stage for uid:', uid);
  const fullURL = getStageURL + uid;
  
  const requestOptions = {
    ...fetchOptions,
    credentials: 'include'
  };
  
  return fetch(fullURL, requestOptions)
    .then(response => {
      if (response.status === 401 || response.status === 403) {
        console.error('AUTHENTICATION ERROR: Plant API call unauthorized');
        return null;
      }
      
      if (response.status !== 200) {
        console.warn("GET plant stage API response failure: " + response.status);
        return null;
      }
      return response.json();
    })
    .then(data => {
      if (data) {
        console.log('Plant stage data received:', data);
        updatePlantDisplay(data.currentStage, data.totalLessons, data.fullyGrown);
        return data;
      }
      return null;
    })
    .catch(err => {
      console.error("Plant stage fetch error:", err);
      return null;
    });
}

// Advance plant stage
function advancePlantStage(uid) {
  console.log('ADVANCING PLANT STAGE for uid:', uid);
  const fullURL = advanceURL + uid + "/next";
  
  const requestOptions = {
    ...postOptions,
    credentials: 'include'
  };
  
  return fetch(fullURL, requestOptions)
    .then(response => {
      if (response.status === 401 || response.status === 403) {
        console.error('AUTHENTICATION ERROR: Plant advance API call unauthorized');
        return null;
      }
      
      if (response.status !== 200) {
        console.warn("POST plant advance API response failure: " + response.status);
        return null;
      }
      return response.json();
    })
    .then(data => {
      if (data) {
        console.log('Plant advance data received:', data);
        updatePlantDisplay(data.currentStage, data.totalLessons, data.fullyGrown);
        
        const message = data.fullyGrown ? 'Your plant is fully grown!' : `Plant grew to stage ${data.currentStage}!`;
        showCelebrationMessage(message);
        
        hasAdvancedThisPage = true;
        return data;
      }
      return null;
    })
    .catch(err => {
      console.error("Plant advance error:", err);
      return null;
    });
}

// Show celebration message
function showCelebrationMessage(message) {
  console.log('Showing celebration:', message);
  
  const celebration = document.createElement('div');
  celebration.style.cssText = `
    position: fixed; bottom: 120px; right: 20px; z-index: 1001;
    background: #4CAF50; color: white; padding: 12px 16px;
    border-radius: 8px; font-size: 14px; font-weight: bold;
    opacity: 0; transition: opacity 0.3s ease; max-width: 200px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  `;
  celebration.textContent = message;
  document.body.appendChild(celebration);
  
  setTimeout(() => celebration.style.opacity = '1', 50);
  setTimeout(() => {
    celebration.style.opacity = '0';
    setTimeout(() => {
      if (celebration.parentNode) {
        celebration.remove();
      }
    }, 300);
  }, 3000);
}

// Check if current page is a tracked lesson page
function isTrackedLessonPage() {
  const path = window.location.pathname;
  return lessonOrder.includes(path);
}

// Get lesson index for current page
function getCurrentLessonIndex() {
  const path = window.location.pathname;
  return lessonOrder.indexOf(path);
}

// Calculate scroll percentage
function getScrollPercentage() {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
  
  if (scrollHeight === 0) return 100; // Page is not scrollable
  
  return Math.min((scrollTop / scrollHeight) * 100, 100);
}

// Setup scroll tracking
function setupScrollTracking() {
  if (!isTrackedLessonPage()) {
    console.log('Not a tracked lesson page, skipping scroll tracking');
    const progressElement = document.getElementById('plant-progress');
    if (progressElement) {
      progressElement.textContent = 'Not a lesson page';
      progressElement.style.color = '#999';
    }
    return;
  }
  
  console.log('Setting up scroll tracking for lesson page');
  hasAdvancedThisPage = false;
  
  // Throttle scroll events for performance
  let scrollTimeout = null;
  
  function handleScroll() {
    if (scrollTimeout) return;
    
    scrollTimeout = setTimeout(() => {
      const scrollPercentage = getScrollPercentage();
      updateScrollProgress(scrollPercentage);
      
      // Check if user has scrolled to bottom (95% threshold to account for different screen sizes)
      if (scrollPercentage >= 95 && !hasAdvancedThisPage && currentUserId) {
        console.log('User reached bottom of lesson page! Advancing plant...');
        advancePlantStage(currentUserId);
      }
      
      scrollTimeout = null;
    }, 100); // Throttle to every 100ms
  }
  
  // Add scroll listener
  window.addEventListener('scroll', handleScroll);
  
  // Initial scroll check (in case user is already at bottom when page loads)
  setTimeout(() => {
    handleScroll();
  }, 1000);
  
  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    window.removeEventListener('scroll', handleScroll);
  });
}

// Listen for page navigation (for single-page apps)
function setupPageChangeListener() {
  // Store original pushState and replaceState
  const originalPushState = history.pushState;
  const originalReplaceState = history.replaceState;
  
  // Override pushState
  history.pushState = function() {
    originalPushState.apply(history, arguments);
    handlePageChange();
  };
  
  // Override replaceState
  history.replaceState = function() {
    originalReplaceState.apply(history, arguments);
    handlePageChange();
  };
  
  // Listen for popstate (back/forward buttons)
  window.addEventListener('popstate', handlePageChange);
}

// Handle page changes
function handlePageChange() {
  const newPage = window.location.pathname;
  
  if (newPage !== currentPage) {
    console.log('Page changed from', currentPage, 'to', newPage);
    currentPage = newPage;
    
    // Reset tracking
    hasAdvancedThisPage = false;
    
    // Setup new tracking if on lesson page
    setTimeout(() => {
      if (currentUserId) {
        getCurrentPlantStage(currentUserId); // Refresh plant display
        setupScrollTracking();
      }
    }, 100);
  }
}

// Initialize plant system
function initializePlant() {
  console.log('Initializing scroll-based plant system...');
  console.log('Tracked lesson pages:', lessonOrder);
  
  getCredentials().then(userData => {
    if (!userData) {
      console.log('No user logged in, skipping plant initialization');
      return;
    }
    
    const uid = userData.uid || userData.id || userData.userId || userData.user_id;
    console.log('User ID found:', uid);
    
    if (!uid) {
      console.error('No valid user ID found in userData:', userData);
      return;
    }
    
    currentUserId = uid;
    
    // Create widget and get initial stage
    createPlantWidget();
    getCurrentPlantStage(uid).then(() => {
      // Start scroll tracking after initial load
      setupScrollTracking();
    });
    
    // Setup page change detection
    setupPageChangeListener();
  });
}

// Initialize when DOM is ready
console.log('Setting up DOM ready event listener...');
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing plant...');
    initializePlant();
  });
} else {
  console.log('DOM already loaded, initializing plant immediately...');
  initializePlant();
}
</script>
</div>

<!-- Load your shared scripts & styles -->
<script src="{{ '/assets/js/lessonbase.js' | relative_url }}"></script>