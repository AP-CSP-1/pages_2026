<head>
    <link rel="stylesheet" href="queue.css">
</head>

<body>
    <div class="queue-container">
        <div class="queue-header">
            <h2 id="teacherName">Mr. Mortensenâ€™s Queue</h2>
        </div>
        
        <div class="queue-info">
            <p id="position">Your position in line: #</p>
            <p id="estimatedTime">Estimated time: ~ mins</p>
        </div>
        
        <div class="queue-list">
            <p>Students currently in line:</p>
            <ul id="studentList">
                <!-- Students will be listed here -->
            </ul>
        </div>

        <div class="queue-actions">
            <button type="button" onclick="addToQueue()">Add Me to Queue</button>
            <button type="button" onclick="removeFromQueue()">Remove Me from Queue</button>
            <button type="button" onclick="goToProfile()">Go to Profile</button>
            <button type="button" onclick="reportIssue()">Report Issue</button>
        </div>        
    </div>
</body>

<script>
    function goToProfile() {
        // Redirect to profile page
        window.location.href = "{{site.baseurl}}/profile";
    }

    function reportIssue() {
        // Redirect to issue report page
        window.location.href = "{{site.baseurl}}/issue";
    }

    // Global variable to store queue data
    window.studentsInQueue = [];

    function displayQueue() {
        const studentList = document.getElementById("studentList");
        studentList.innerHTML = ""; // Clear the list

        window.studentsInQueue.forEach((student) => {
            const listItem = document.createElement("li");
            listItem.textContent = student;
            if (student === studentName) listItem.style.color = "red"; // Highlight user's name in red
            studentList.appendChild(listItem);
        });

        // Update position and estimated time
        const position = window.studentsInQueue.indexOf(studentName) + 1;
        document.getElementById("position").textContent = `Your position in line: #${position}`;
        document.getElementById("estimatedTime").textContent = `Estimated time: ~${position * 3} mins`;
    }

    // Initial display
    displayQueue();
</script>

<script>
    const url = `http://localhost:8085/api/queue`;
    const getUrl = url + '/all';
    const addUrl = url + '/add';
    const removeUrl = url + '/remove';

    const fetchOptions = {
        headers: {
            "Content-Type": "application/json"
        }
    };

    const postOptions = {
        ...fetchOptions,
        method: 'POST',
    };
    const deleteOptions = {
        ...fetchOptions,
        method: 'DELETE',
    };

    // Get teacher name and student name from local storage or variables
    const teacherName = "Mortensen"; // Replace with dynamic teacher name if needed
    const studentName = localStorage.getItem("email"); // Assume stored from login

    // Function to fetch and display Mortensen's queue data
    function fetchQueueData() {
        fetch(getUrl, fetchOptions)
            .then(response => {
                if (response.status !== 200) {
                    console.error("Failed to fetch queue data.");
                    return;
                }
                return response.json();
            })
            .then(data => {
                console.log("Queue data:", data);
                const mortensenQueue = data.find(queue => queue.teacherName === teacherName);
                if (mortensenQueue) {
                    window.studentsInQueue = mortensenQueue.peopleQueue.split(','); // Convert the queue string into an array
                    displayQueue();
                } else {
                    console.error("Mortensen's queue not found.");
                }
            })
            .catch(error => console.error("Error fetching data:", error));
    }

    // Function to add student to the queue
    function addToQueue() {
        const queuer = {
            teacherName: teacherName,
            studentName: studentName,
        };

        fetch(addUrl, {
            ...postOptions,
            body: JSON.stringify(queuer),
        })
        .then(response => {
            if (response.ok) {
                fetchQueueData(); // Refresh the queue after adding
            } else {
                alert("Failed to add to queue.");
            }
        })
        .catch(error => console.error("Error adding to queue:", error));
        console.log("Added to queue:", queuer);
    }

    // Function to remove student from the queue
    function removeFromQueue() {
        const queuer = {
            teacherName: teacherName,
            studentName: studentName,
        };

        fetch(removeUrl, {
            ...deleteOptions,
            body: JSON.stringify(queuer),
        })
        .then(response => {
            if (response.ok) {
                fetchQueueData(); // Refresh the queue after removing
            } else {
                alert("Failed to remove from queue.");
            }
        })
        .catch(error => console.error("Error removing from queue:", error));
        console.log("Removed from queue:", queuer);
    }

    // Fetch data every 10 seconds
    setInterval(fetchQueueData, 10000);

    // Initial fetch
    fetchQueueData();
</script>
